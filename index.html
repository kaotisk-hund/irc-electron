<!DOCTYPE html>
<html class="no-js" lang="en" dir="ltr">
	<head>
		<title>KiRc</title>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="assets/css/foundation.css">
		<link rel="stylesheet" href="assets/css/app.css">
	</head>
<body>
	<div id="main" class="grid-container">
		<div id="top" class="grid-x">
			<div id="title-i-guess" class="small-9 cell">
				<h2>Messages</h2>
			</div>
			<div id="status" class="small-3 cell">
				<button id="status-button" class="button alert">Disconnected</button>
			</div>
		</div>
	</div>
	<div class="grid-container">
		<div class="grid-x">
			<div class="small-12 cell messages" style="
				max-height: 400px;
				overflow: scroll;
				height: 400px;
			">
			</div>
		</div>
	</div>
	<div class="grid-container">
		<div class="send">
			<form id="messaging">
				<div class="grid-x">
					<div class="small-9 cell">
						<input type="text" id="message" placeholder="Enter your message here..." autofocus="true">
					</div>
					<div class="small-3 cell">
						<button id="message_send" class="button" type="submit">Send</button>
					</div>
				</div>
			</form>
			<form id="sharing" method="post" enctype="multipart/form-data">
				<div>
					<label for="file">Choose file to upload</label>
					<input type="file" id="file" name="file">
				</div>
				<div>
					<button id="file_upload" class="button">Share!</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		const electron = require('electron');
		const {ipcRenderer} = electron;

		/*
		 * Sending messages
		 */
		document.querySelector('#messaging').addEventListener('submit', sendMessage);
		function sendMessage(e){
			e.preventDefault();
			message = document.querySelector('#message').value;

			ipcRenderer.send('irc_send', message);

			message = '';
			document.querySelector('#message').value = '';
		}

		/*
		 * Sending files
		 */
		document.querySelector('#sharing').addEventListener('submit', sendFile);
		function sendFile(e){
			e.preventDefault();
			file = document.querySelector('#file').files[0];
			ipcRenderer.send('ipfs_upload', file.path, file.name);
			file = '';
			//document.querySelector('#message').value = '';
		}

		/*
		 * Messages handling
		 */
		const div = document.querySelector('.messages');
		ipcRenderer.on('irc_message', function(e, data){
			const p = document.createElement('pre');
			p.className = 'message';
			const message = document.createTextNode(data.from + ": " + data.message);
			p.appendChild(message);
			div.appendChild(p);
			p.scrollIntoView();
		});

		/*
		 * Files handling
		 */
		//const div = document.querySelector('.messages');
		ipcRenderer.on('ipfs_file', function(e, data){
			const p = document.createElement('p');
			p.className = 'file';
			const file_des = document.createTextNode(data.file + " -> " + data.hash);
			p.appendChild(file_des);
			div.appendChild(p);
		});

		/*
		 * Connected show!
		 * For now if you are connected once, it does change to connected.
		 * TODO: Change back to disconnected when disconnected.
		 */
		const status = document.querySelector('#status');
		ipcRenderer.on('irc_cded', function(e, data){
			const button_dced = document.querySelector('#status-button');
			button_dced.className = 'button success';
			const cded_mess = 'Connected';
			button_dced.innerHTML = cded_mess;
		});
		

	</script>
</body>
</html>
